# GIS-PD实时分析平台

这是一个基于MQTT协议的GIS（气体绝缘开关设备）局部放电实时分析平台，使用PySide6构建GUI界面，并通过matplotlib实现数据可视化。

**🆕 最新更新 (2025.7.23)**：新增智能轴范围调整系统和专业正弦波显示，默认使用dBm单位，提供更专业的电力设备监测体验。

## 功能特点

- **现代化UI设计**：采用侧边栏与主视图结合的专业布局，支持侧边栏的折叠与展开，并可通过**`QSplitter`**自由调整区域大小，实现面板的灵活伸缩。
- **顶部工具栏**：集成了核心图表操作（缩放、平移、保存）和常用功能（清除数据、重置周期），按钮同时显示图标和文字，清晰直观。**该工具栏支持拖动到主窗口的任意边缘（上、下、左、右）进行停靠，也可以拖离主窗口，使其作为一个独立的浮动窗口使用，极大提升了操作灵活性。**
- 通过MQTT协议实时接收局部放电数据
- 支持多种图表显示方式（散点图、颜色散点图、线图）
- 左右双图布局：左侧PRPD图，右侧PRPS三维图，两图均分空间
- 优化的图表布局，提供更平衡的视觉效果和更好的数据可视化体验
- 可调整数据缓冲区大小
- 实时显示连接状态和数据点数量
- 多线程处理MQTT通信，避免主线程阻塞
- 消息队列缓冲机制，提高数据处理效率
- 优化的图表绘制策略，减少UI卡顿
- 线程安全的数据访问机制
- 支持数据周期累积显示，可自定义累积周期数
- **智能参考正弦波显示**：在PRPD图中叠加显示专业标准的参考正弦波
  - dBm模式：正弦波在-50到0 dBm范围内波动，振幅25 dBm，偏移-25 dBm
  - mV模式：正弦波参数自动转换为对应毫伏值，保持专业比例
  - 简化的控制界面：仅保留显示/隐藏切换，参数完全由系统智能计算
  - 所有绘图场景保持一致的正弦波标准，便于专业分析放电相位
- **动态轴范围调整系统**：根据当前单位智能调整图表显示范围
  - PRPD图Y轴和PRPS图Z轴支持dBm/mV模式的实时切换
  - dBm模式：固定专业范围(-50到0 dBm)，符合电力监测标准
  - mV模式：自动计算对应毫伏值范围，确保数据完整显示
  - 单位切换时轴范围无缝自动调整，提升用户体验
- **专业单位系统**：默认使用dBm单位，更符合电力设备监测的行业标准
  - 支持在毫伏(mV)和分贝毫瓦(dBm)单位之间灵活切换
  - 精确的单位转换算法：dBm = 毫伏值 × 54.545 - 81.818
  - 界面启动即显示专业dBm单位，提升专业性
- **自定义颜色方案**：支持多种预设颜色方案，增强PRPS三维图的可视化效果
- **数据库存储**：支持将接收到的数据保存到SQLite数据库，便于后期分析和查询
- **历史数据可视化**：支持从数据库查询历史数据并生成PRPD和PRPS图表
- **CSV数据导出**：支持将累积的周期数据导出为CSV格式，便于在其他软件中分析
- **独立自动保存图像**：支持分别自动保存PRPD图和PRPS图到独立文件夹，用户可根据需求选择要保存的图表类型


<img width="1502" height="914" alt="image" src="https://github.com/user-attachments/assets/bc014cbc-45ec-41ed-a8d1-181a50c78b0f" />
<img width="1502" height="914" alt="image" src="https://github.com/user-attachments/assets/2276e1fa-ff56-4a4c-8dd0-ea185962f340" />
<img width="1502" height="914" alt="image" src="https://github.com/user-attachments/assets/bc5289f1-1f2b-4f13-bc07-809b77109399" />
<img width="1502" height="914" alt="image" src="https://github.com/user-attachments/assets/84763d91-f451-4ce6-a9ec-4cf3830bebca" />
<img width="1502" height="914" alt="image" src="https://github.com/user-attachments/assets/ee981d85-5187-4df1-8a68-154a55c3cba4" />
<img width="1502" height="914" alt="image" src="https://github.com/user-attachments/assets/91e5fb18-b245-4562-a308-dbd8190eefb7" />
<img width="1920" height="1020" alt="image" src="https://github.com/user-attachments/assets/e641db69-b465-4e5b-ba25-e88ec07ee5c4" />
<img width="1920" height="1020" alt="image" src="https://github.com/user-attachments/assets/6842ae2c-8f17-4150-a440-24dd9a087541" />
<img width="1920" height="1020" alt="image" src="https://github.com/user-attachments/assets/a3d8a307-bb30-47f7-8653-bedba185689a" />


## 更新日志

### 2025年7月23日
- **默认单位优化**：
  - 将系统默认单位从毫伏(mV)更改为分贝毫瓦(dBm)，更符合专业电力监测需求
  - 界面启动时单位按钮默认显示"单位: dBm"
  - 所有图表的默认单位标签更新为"幅值 (dBm)"
- **智能正弦波显示优化**：
  - **dBm模式**：正弦波振幅设置为25 dBm，偏移量为-25 dBm，使正弦波在-50到0 dBm范围内完美波动
  - **mV模式**：正弦波参数自动转换为对应的毫伏值，保持相同的相对比例
  - 移除了基于数据范围的动态正弦波缩放，改为固定的专业参考标准
  - 在所有绘图场景（实时显示、历史数据查看、自动保存图像）中保持一致的正弦波显示
- **动态轴范围调整系统**：
  - **PRPD图Y轴智能调整**：dBm模式固定为-50到0 dBm，mV模式自动转换为对应的毫伏值范围
  - **PRPS图Z轴智能调整**：同样支持dBm和mV模式的动态范围切换
  - 单位切换时轴范围实时自动调整，无需手动设置
  - 确保在任何单位下数据都能以最佳范围显示，提升数据可读性
- **用户界面简化优化**：
  - 移除了正弦波振幅手动调整控件，简化用户界面
  - 保留正弦波显示/隐藏切换功能，满足基本使用需求
  - 正弦波参数完全由系统智能计算，无需用户手动干预
  - 界面布局更加紧凑美观，专注于核心功能展示
- **代码架构优化**：
  - 新增`get_axis_range()`函数：根据当前单位智能计算轴范围
  - 新增`get_sine_wave_params()`函数：根据当前单位计算正弦波参数
  - 统一了所有绘图函数的轴范围和正弦波参数计算逻辑
  - 移除了冗余的振幅调整相关代码，提高代码简洁性和维护性
  - 确保功能在主界面、历史数据查看、自动保存等所有场景中的一致性

### 2025年7月14日
- **UI现代化重构**：
  - 引入了全新的现代化用户界面布局，提升了专业性和用户体验。
  - **可折叠侧边栏**：将所有控制选项移至左侧的可折叠面板，为图表区提供更多空间。
  - **顶部工具栏**：创建了自定义的顶部工具栏，集成了核心的图表操作和常用功能。
  - **可调整布局**：使用`QSplitter`实现侧边栏和图表区的宽度可自由拖动调整。
  - **系统原生图标**：为工具栏和按钮全面适配了系统原生图标，使界面更加美观和直观。
  - **图标与文字并存**：工具栏按钮现在同时显示图标和文字，解决了仅有图标辨识度不高的问题。
  - **窗口图标**：为应用程序主窗口添加了系统图标。
- **控制台输出修复**：修复了在Windows环境下控制台输出中文乱码的问题。
- **UI状态同步Bug修复**：修复了当取消缩放或平移模式时，自定义工具栏按钮状态没有同步更新的Bug。

### 2025年7月8日
- **修复PRPS图周期显示顺序问题**：修改数据库查询结果的处理方式，在`HistoricalChartsDialog`类的初始化方法中反转数据顺序，使PRPS图中的周期按照时间顺序正确显示（从周期1到周期N）
- **隐藏颜色条**：移除PRPD和PRPS图中的颜色条显示，提供更干净的视觉效果并增加数据可视化空间
- **改进界面布局**：优化PRPD和PRPS图的布局，确保两图均分空间，提供更平衡的视觉体验
- **更新软件名称**：将软件名称从"GIS局部放电在线监测系统"更改为"GIS-PD实时分析平台"，更准确地反映软件功能

### 2025年7月3日
- 隐藏了PRPD颜色散点图和PRPS三维图的颜色条，使界面更加简洁：
  - 移除了主界面上PRPD颜色散点图的颜色条显示
  - 移除了主界面上PRPS三维图的颜色条显示
  - 修改了自动保存图像功能，保存的图像中也不显示颜色条
  - 修改了历史数据查看对话框中的图表，保持与主界面一致的风格
- 改进了PRPD图和PRPS图的界面布局，确保两个图表均分空间：
  - 使用精确的位置参数创建子图，确保两个图表占用相等的空间
  - 优化了图表间距和边距设置，提供更平衡的视觉效果
  - 增加了轴标签的字体大小和内边距，提高可读性
  - 调整了3D图的宽高比和视角设置，提供更好的数据可视化体验
  - 确保历史数据查看对话框中的图表也能均分空间

### 2025年7月2日
- 优化了自动保存图像功能：
  - 将自动保存功能分成两个独立选项："自动保存PRPD图"和"自动保存PRPS图"
  - 用户可以根据需要选择只保存PRPD图、只保存PRPS图或同时保存两种图
  - 自动创建独立的保存文件夹：PRPD图保存至"saved_images/PRPD"目录，PRPS图保存至"saved_images/PRPS"目录
  - 使用相同的时间戳命名保存的图像，便于关联同一时间点的不同图表
  - 状态栏会显示实时保存状态，指示当前保存的图像类型和文件名
  - 重构了图像保存逻辑，提高代码复用性和可维护性
  - 优化了界面布局，将自动保存选项移到右侧，避免与其他控件重叠

### 2025年7月1日
- 优化了用户界面布局，引入选项卡设计：
  - 将连接设置和图表设置整合到选项卡控件中
  - 最大化图表显示区域，提升数据可视化效果
  - 限制选项卡区域高度，使图表占据更多空间
  - 优化了控件布局，提高界面整洁度和可用性
  - 使用伸缩策略，确保图表区域优先获得空间
  - 增加了画布高度，改进图表细节显示
- 重新组织了设置控件：
  - "连接设置"选项卡整合了MQTT连接和数据库相关控件
  - "图表设置"选项卡包含所有与图表显示相关的控件
  - 添加了快捷操作按钮到连接设置选项卡
- 增强了显示和保存功能：
  - 移除了"显示PRPS三维图"选项，始终同时显示PRPD和PRPS两个图表
  - 改进了自动保存功能，现在会同时保存PRPD和PRPS两张图像
  - 自动保存的图像文件命名为"PRPD_时间戳.png"和"PRPS_时间戳.png"
  - 优化了图表保存质量，提高了分辨率和细节表现

### 2025年6月30日
- 修复了历史数据查询界面中查看PRPS三维图显示的错误
- 解决了FigureCanvas对象属性引用错误的问题
- 优化了历史数据图表的绘制逻辑，确保数据显示正确
- 统一了主界面和历史数据查询界面的图表绘制方式

### 2025年6月26日
- 新增了PRPD颜色散点图功能：
  - 支持以颜色渐变方式显示放电强度
  - 数据值越大，颜色越亮
  - 颜色映射使用与PRPS图相同的颜色方案
  - 在PRPD图和历史数据查询中均可使用
- 优化了图表布局：
  - 修复了颜色散点图被PRPS图挤压的问题
  - 动态调整图表与颜色条的间距
  - 根据是否显示3D图自动调整布局参数
  - 平衡显示区域分配，确保图表可读性
- 改进了PRPD和PRPS图表的空间分配：
  - 使用GridSpec精确控制左右子图的大小比例
  - 确保PRPD和PRPS图表各占50%显示空间
  - 优化了子图间距和边距设置
  - 调整了3D图的视角和宽高比，提高可读性
  - 优化了颜色条的大小和位置，避免挤压主图表
  - 根据不同图表类型自动应用最佳布局设置

### 2025年6月25日
- 优化了数据库文件和图像保存路径处理机制：
  - 确保数据库文件(gis_pd_data.db)保存在可执行文件所在的根目录下
  - 确保图像文件保存在可执行文件所在目录下的saved_images文件夹中
  - 修复了打包成exe后数据库文件无法正确创建的问题
  - 不再使用PyInstaller临时目录(_MEIPASS)保存数据，避免应用关闭后数据丢失
  - 添加了"查看路径"按钮，方便用户查看数据库和图像的保存位置
  - 增强了路径处理的错误捕获和回退机制，提高程序稳定性

### 2025年6月20日
- 添加了单位转换功能，支持在毫伏(mV)和分贝毫瓦(dBm)之间切换
- 修复了PRPS 3D图表的Z轴范围自动调整功能：
  - 针对dBm单位进行特殊处理，确保Z轴最小值不低于-80 dBm
  - 自动调整Z轴范围，确保数据显示清晰且有意义
  - 对于毫伏单位，确保最小值不低于0（物理上有意义）
  - 修复了在单位切换时Z轴范围不正确的问题
- 改进了历史数据查询功能，支持更精确的时间范围筛选

## 技术实现

- **PySide6**: 用于构建现代化GUI界面，包括`QSplitter`, `QToolBar`, `QAction`等高级组件
- **MQTT**: 使用paho-mqtt库实现MQTT通信
- **Matplotlib**: 用于数据可视化，支持多种图表类型
- **Matplotlib 3D**: 使用mplot3d工具包实现三维PRPS图
- **多线程**: 使用QThread处理MQTT通信，避免阻塞主线程
- **消息队列**: 使用Python的queue模块实现消息缓冲
- **互斥锁**: 使用QMutex保证线程安全
- **定时器**: 使用QTimer控制UI更新频率和自动保存功能
- **自定义颜色映射**: 使用LinearSegmentedColormap创建自定义颜色方案
- **动态轴范围系统**: 智能计算和调整图表显示范围，支持单位切换时的实时更新
- **专业正弦波算法**: 基于电力监测标准的正弦波参数计算和显示
- **单位转换引擎**: 高精度的dBm和mV单位转换算法，确保数据准确性
- **SQLite**: 使用轻量级的SQLite数据库进行数据存储与管理
- **CSV**: 使用Python的csv模块实现数据导出功能

## 使用方法

1. 运行程序：

```bash
python gis_pd_mqtt_gui_ui_revamp.py
```

2. 在左侧侧边栏中设置MQTT Broker的地址、端口和主题
3. 点击"连接"按钮连接到MQTT服务器
4. 连接成功后，系统将自动接收数据并绘制PRPD和PRPS图（默认使用dBm单位显示）
5. 使用顶部的现代化工具栏可以进行缩放、平移、保存图表、折叠侧边栏等操作
6. 在侧边栏中可以调整PRPD图的类型、累积周期数、参考正弦波显示、颜色方案等
7. 使用"单位"按钮可以在dBm和mV单位之间切换，轴范围和正弦波参数会自动调整
8. 正弦波参数由系统智能计算，无需手动调整，确保专业标准的参考显示
9. 在侧边栏中可以控制数据是否保存到数据库、查看数据库、导出CSV、自动保存图像等
10. 使用"查看文件路径"按钮可以查看数据库文件和图像保存的具体位置

## 数据格式

系统接收十六进制格式的数据，每4个字符解析为一个16进制数，并按以下公式转换：
- **原始数据转换**：转换值 = 十进制值 × 3.3 ÷ 4096，单位为毫伏(mV)
- **单位转换公式**：
  - 毫伏转dBm：dBm = 毫伏值 × 54.545 - 81.818
  - dBm转毫伏：毫伏值 = (dBm值 + 81.818) ÷ 54.545
- **显示范围**：
  - dBm模式：固定显示范围-50到0 dBm（专业电力监测标准）
  - mV模式：对应的毫伏值范围（约0.58到1.50 mV）
- **正弦波参考**：
  - dBm模式：振幅25 dBm，中心偏移-25 dBm
  - mV模式：对应转换后的毫伏值参数

## 系统要求

- Python 3.6+
- PySide6
- paho-mqtt
- matplotlib (含mplot3d)
- numpy
- sqlite3 (Python标准库)
